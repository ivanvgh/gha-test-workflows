name: PR Feedback

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify-author:
    name: DM Author on Feedback
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login != github.actor &&
      github.actor != 'copilot[bot]' &&
      (github.event.review.state == 'changes_requested' ||
       github.event.review.state == 'commented')

    steps:
      - name: Get Slack user ID from email
        id: slack-user
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          # Get email from user's commits
          GITHUB_EMAIL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits?author=${{ github.event.pull_request.user.login }}&per_page=1" \
            | jq -r '.[0].commit.author.email // empty')

          echo "GitHub email: $GITHUB_EMAIL"

          if [ -n "$GITHUB_EMAIL" ]; then
            RESPONSE=$(curl -s -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              "https://slack.com/api/users.lookupByEmail?email=$GITHUB_EMAIL")

            SLACK_ID=$(echo "$RESPONSE" | jq -r '.user.id // empty')

            if [ -n "$SLACK_ID" ] && [ "$SLACK_ID" != "null" ]; then
              echo "user_id=$SLACK_ID" >> $GITHUB_OUTPUT
              echo "found=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "found=false" >> $GITHUB_OUTPUT

      - name: Set notification message
        id: message
        env:
          REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          if [ "${{ github.event.review.state }}" == "changes_requested" ]; then
            echo "emoji=ðŸ”„" >> $GITHUB_OUTPUT
            echo "title=Changes requested on your PR" >> $GITHUB_OUTPUT
          else
            echo "emoji=ðŸ’¬" >> $GITHUB_OUTPUT
            echo "title=New review comment on your PR" >> $GITHUB_OUTPUT
          fi

          # Truncate comment if too long (max 200 chars)
          if [ -n "$REVIEW_BODY" ]; then
            TRUNCATED=$(echo "$REVIEW_BODY" | head -c 200)
            if [ ${#REVIEW_BODY} -gt 200 ]; then
              TRUNCATED="${TRUNCATED}..."
            fi
            echo "comment=$TRUNCATED" >> $GITHUB_OUTPUT
            echo "has_comment=true" >> $GITHUB_OUTPUT
          else
            echo "has_comment=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Slack payload
        id: payload
        env:
          REVIEW_COMMENT: ${{ steps.message.outputs.comment }}
        run: |
          COMMENT_BLOCK=""
          if [ "${{ steps.message.outputs.has_comment }}" == "true" ]; then
            # Escape quotes for JSON
            ESCAPED_COMMENT=$(echo "$REVIEW_COMMENT" | sed 's/"/\\"/g' | tr '\n' ' ')
            COMMENT_BLOCK=',{"type": "section", "text": {"type": "mrkdwn", "text": "ðŸ’¬ _'"$ESCAPED_COMMENT"'_"}}'
          fi
          echo "comment_block=$COMMENT_BLOCK" >> $GITHUB_OUTPUT

      - name: Send DM to PR author
        if: steps.slack-user.outputs.found == 'true'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ steps.slack-user.outputs.user_id }}",
              "text": "${{ steps.message.outputs.title }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.message.outputs.emoji }} *${{ steps.message.outputs.title }}*\n<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}>"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ðŸ‘¤ Reviewed by *${{ github.event.review.user.login }}*"
                    }
                  ]
                }
                ${{ steps.payload.outputs.comment_block }}
                ,{
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": { "type": "plain_text", "text": "View Review" },
                      "url": "${{ github.event.review.html_url }}"
                    }
                  ]
                }
              ]
            }
